{% extends "base.html" %}
{% block title %}Generate Demand{% endblock %}

{% block header_title %}Demand Generator{% endblock %}

{% block content %}
<div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400 p-4 mb-8 rounded-r-lg">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fa-solid fa-file-invoice text-blue-600 dark:text-blue-400"></i>
        </div>
        <div class="ml-3">
            <p class="text-sm text-blue-700 dark:text-blue-300">
                <strong>Instructions:</strong> Select Location & Files. The Panchayat Name will auto-fill from the Scheme file. Use "Individual Mode" to select specific labourers and see family suggestions.
            </p>
        </div>
    </div>
</div>

<div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
    <h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 uppercase tracking-wider">
        <i class="fa-solid fa-map-location-dot mr-2"></i> Global Location Settings
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">District</label>
            <select id="global-sel-dist" class="w-full p-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-900 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-primary">
                <option value="">-- Select District --</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Block</label>
            <select id="global-sel-block" disabled class="w-full p-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-900 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-primary">
                <option value="">-- Select Block --</option>
            </select>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
    
    <div>
        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">1. Select Scheme List</label>
        
        <div class="flex gap-2 mb-3 text-xs">
            <button type="button" id="tab-scheme-upload" class="px-3 py-1 bg-primary text-white rounded transition-colors">Upload CSV</button>
            <button type="button" id="tab-scheme-server" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 transition-colors">From Server</button>
        </div>

        <div id="source-scheme-upload" class="block">
            <div class="flex items-center gap-3">
                <input type="file" id="scheme_csv" accept=".csv" class="hidden">
                <label for="scheme_csv" class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-file-csv mr-2 text-yellow-600"></i> Choose File
                </label>
                <span id="scheme-file-name" class="text-xs text-gray-500 dark:text-gray-400 italic truncate max-w-[150px]">Optional</span>
            </div>
        </div>

        <div id="source-scheme-server" class="hidden space-y-2">
            <div class="text-xs text-gray-500 mb-1">Select a file from the chosen Block:</div>
            <select id="scheme-sel-file" disabled class="w-full p-2 text-xs border rounded bg-white dark:bg-gray-900 dark:border-gray-600 dark:text-white">
                <option value="">-- Select Scheme File --</option>
            </select>
            <button type="button" id="btn-load-scheme-server" disabled class="w-full py-1.5 bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold rounded disabled:opacity-50">Load Scheme List</button>
        </div>

        <div id="scheme-control-area" class="hidden mt-4 space-y-2 animate-fade-in">
            <input type="text" id="scheme_filter" placeholder="Search scheme..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-primary">
            <select id="scheme_select" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-primary">
                <option value="">-- Select Scheme --</option>
            </select>
        </div>
    </div>

    <div>
        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">2. Select Labour List</label>
        
        <div class="flex gap-2 mb-3 text-xs">
            <button type="button" id="tab-labour-upload" class="px-3 py-1 bg-primary text-white rounded transition-colors">Upload CSV</button>
            <button type="button" id="tab-labour-server" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 transition-colors">From Server</button>
        </div>

        <div id="source-labour-upload" class="block">
            <div class="flex items-center gap-3">
                <input type="file" id="labour_csv" accept=".csv" class="hidden">
                <label for="labour_csv" class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-users mr-2 text-green-600"></i> Choose File
                </label>
                <span id="labour-file-name" class="text-xs text-gray-500 dark:text-gray-400 italic truncate max-w-[150px]">Optional</span>
            </div>
        </div>

        <div id="source-labour-server" class="hidden space-y-2">
            <div class="text-xs text-gray-500 mb-1">Select a file from the chosen Block:</div>
            <select id="labour-sel-file" disabled class="w-full p-2 text-xs border rounded bg-white dark:bg-gray-900 dark:border-gray-600 dark:text-white">
                <option value="">-- Select Labour File --</option>
            </select>
            <button type="button" id="btn-load-labour-server" disabled class="w-full py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded disabled:opacity-50">Load Labour List</button>
        </div>

        <div id="labour-stats" class="hidden mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg flex justify-between text-xs font-medium text-blue-800 dark:text-blue-200 animate-fade-in">
            <span>Total: <strong id="lbl-total">0</strong></span>
            <span>Used: <strong id="lbl-used">0</strong></span>
            <span class="text-green-600 dark:text-green-400">Remaining: <strong id="lbl-remain">0</strong></span>
        </div>
    </div>
</div>

<form method="post" action="{{ url_for('demand_tool') }}" id="demand-form" target="_blank" class="space-y-6">
    
    <input type="hidden" name="scheme_full_name" id="hidden_scheme_name">
    <input type="hidden" name="work_code" id="hidden_work_code">

    <div>
        <label for="panchayat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Panchayat Name (Auto-filled)</label>
        <input type="text" name="panchayat" id="panchayat" placeholder="Select scheme file to auto-fill" required
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary shadow-sm" readonly>
    </div>

    <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="flex gap-4 mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
            <button type="button" id="mode-batch" class="text-sm font-bold text-primary border-b-2 border-primary pb-1">Batch Mode</button>
            <button type="button" id="mode-individual" class="text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 pb-1">Select Individual</button>
        </div>

        <div id="panel-batch" class="block animate-fade-in">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Add Next Batch of Labours</label>
            <div class="flex items-center">
                <div class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-800 mr-4">
                    <button type="button" onclick="adjustCount(-1)" class="px-3 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"><i class="fa-solid fa-minus text-xs"></i></button>
                    <input type="number" id="labour_count" value="10" min="1" max="20" class="w-12 text-center border-none focus:ring-0 p-0 text-gray-900 dark:text-white font-semibold bg-transparent">
                    <button type="button" onclick="adjustCount(1)" class="px-3 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"><i class="fa-solid fa-plus text-xs"></i></button>
                </div>
                <button type="button" id="btn-add-batch" class="flex-1 inline-flex justify-center items-center px-4 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg transition-colors text-sm font-medium">
                    <i class="fa-solid fa-layer-group mr-2"></i> Add Batch
                </button>
            </div>
        </div>

        <div id="panel-individual" class="hidden animate-fade-in">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search & Select Labour (Type Name or JC)</label>
            <div class="flex gap-2 mb-4 relative">
                <div class="relative w-full">
                    <input type="text" id="labour-search-input" placeholder="Type village e.g. 12/ or Suffix..." 
                        class="w-full p-3 text-sm border rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-green-500" autocomplete="off">
                    
                    <div id="search-dropdown" class="hidden absolute z-50 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto custom-scrollbar">
                        </div>
                </div>
                
                <button type="button" id="btn-add-individual" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg whitespace-nowrap">
                    <i class="fa-solid fa-plus"></i> Add
                </button>
            </div>

            <div id="suggestions-box" class="hidden bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-3">
                <div class="text-xs font-bold text-yellow-800 dark:text-yellow-200 mb-2 uppercase tracking-wide flex justify-between items-center">
                    <span><i class="fa-solid fa-people-group mr-1"></i> Suggested Neighbours</span>
                    <span class="text-[10px] opacity-70">(Next available)</span>
                </div>
                <div id="suggestions-list" class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mt-6">
        <h3 id="form-preview-title" class="text-lg font-bold text-gray-800 dark:text-gray-100">Form Preview (0 Labours)</h3>
        <div class="h-4"></div>
    </div>

    <div id="scheme-preview-text" class="hidden bg-indigo-50 dark:bg-indigo-900/20 border-l-4 border-indigo-500 p-4 rounded-r-lg mb-4">
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
            <div>
                <div class="text-xs uppercase tracking-wider text-indigo-500 font-bold mb-1">Selected Scheme</div>
                <div id="preview_scheme_name" class="font-medium text-gray-900 dark:text-gray-100 text-sm md:text-base">None</div>
            </div>
            <div class="md:text-right">
                <div class="text-xs uppercase tracking-wider text-indigo-500 font-bold mb-1">Work Code</div>
                <div id="preview_work_code" class="inline-block bg-indigo-100 dark:bg-indigo-800 text-indigo-800 dark:text-indigo-200 px-2 py-1 rounded text-xs font-mono font-bold">None</div>
            </div>
        </div>
    </div>

    <div class="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden shadow-sm bg-white dark:bg-dark-card">
        <div class="overflow-x-auto">
            <table id="labour-table" class="min-w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400 font-medium">
                    <tr>
                        <th class="px-4 py-3 w-16">Sr.</th>
                        <th class="px-4 py-3">Job Card No.</th>
                        <th class="px-4 py-3">Labour Name</th>
                        <th class="px-4 py-3 w-16 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="labour-tbody" class="divide-y divide-gray-200 dark:divide-gray-700 text-gray-700 dark:text-gray-300">
                </tbody>
            </table>
        </div>
    </div>

    <div class="pt-4 flex flex-col md:flex-row gap-4">
        <button type="submit" onclick="autoSaveDemand()" class="w-full md:w-auto inline-flex justify-center items-center px-8 py-3 bg-primary hover:bg-blue-700 text-white text-base font-medium rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
            <i class="fa-solid fa-print mr-2"></i> Generate & Download
        </button>
        
        <button type="button" id="btn-reset-all" class="w-full md:w-auto inline-flex justify-center items-center px-6 py-3 bg-red-50 hover:bg-red-100 text-red-600 dark:bg-red-900/20 dark:hover:bg-red-900/30 dark:text-red-400 text-base font-medium rounded-lg transition-colors border border-red-200 dark:border-red-800/50">
            <i class="fa-solid fa-rotate-left mr-2"></i> Reset All
        </button>
    </div>
</form>

<script>
    // --- GLOBAL STATE ---
    let schemes = [];
    let allLabours = [];
    let currentLabourIndex = 0;
    let publicDataStructure = {};
    let currentMode = 'batch';
    let lastSearchedIndex = -1; 

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initServerData();
        setupModeToggles();
        setupTabs('scheme');
        setupTabs('labour');
    });

    // --- SOUND FUNCTION ---
    function playSuccessSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.1);
        oscillator.stop(audioContext.currentTime + 0.1);
    }

    // --- TAB LOGIC ---
    function setupTabs(prefix) {
        const tUp = document.getElementById(`tab-${prefix}-upload`);
        const tSv = document.getElementById(`tab-${prefix}-server`);
        const dUp = document.getElementById(`source-${prefix}-upload`);
        const dSv = document.getElementById(`source-${prefix}-server`);

        if(!tUp || !tSv) return;

        tUp.addEventListener('click', () => {
            dUp.classList.remove('hidden'); dSv.classList.add('hidden');
            tUp.className = "px-3 py-1 bg-primary text-white rounded transition-colors";
            tSv.className = "px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 transition-colors";
        });

        tSv.addEventListener('click', () => {
            dSv.classList.remove('hidden'); dUp.classList.add('hidden');
            tSv.className = "px-3 py-1 bg-primary text-white rounded transition-colors";
            tUp.className = "px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 transition-colors";
        });
    }

    // --- SERVER DATA LOGIC ---
    async function initServerData() {
        try {
            const res = await fetch('/api/public/locations');
            if(res.ok) {
                publicDataStructure = await res.json();
                populateGlobalDistricts();
            }
        } catch(e) { console.error("Location fetch failed", e); }
    }

    function populateGlobalDistricts() {
        const sel = document.getElementById('global-sel-dist');
        if(!sel) return;
        sel.innerHTML = '<option value="">-- Select District --</option>';
        Object.keys(publicDataStructure).sort().forEach(d => {
            sel.innerHTML += `<option value="${d}">${d}</option>`;
        });
        sel.addEventListener('change', onGlobalDistrictChange);
        document.getElementById('global-sel-block').addEventListener('change', onGlobalBlockChange);
    }

    function onGlobalDistrictChange() {
        const dist = this.value;
        const blockSel = document.getElementById('global-sel-block');
        blockSel.innerHTML = '<option value="">-- Select Block --</option>';
        blockSel.disabled = !dist;
        resetFileDropdowns();
        if(dist && publicDataStructure[dist]) {
            Object.keys(publicDataStructure[dist]).sort().forEach(b => {
                blockSel.innerHTML += `<option value="${b}">${b}</option>`;
            });
        }
    }

    function onGlobalBlockChange() {
        const dist = document.getElementById('global-sel-dist').value;
        const block = this.value;
        updateFileDropdown('scheme', dist, block);
        updateFileDropdown('labour', dist, block);
    }

    function updateFileDropdown(type, dist, block) {
        const fileSel = document.getElementById(`${type}-sel-file`);
        const loadBtn = document.getElementById(`btn-load-${type}-server`);
        
        fileSel.innerHTML = `<option value="">-- Select ${type === 'scheme' ? 'Scheme' : 'Labour'} File --</option>`;
        fileSel.disabled = !block;
        loadBtn.disabled = true;

        if(dist && block && publicDataStructure[dist][block]) {
            publicDataStructure[dist][block].sort().forEach(f => {
                if (type === 'scheme' && !f.toLowerCase().includes('_schemes.csv')) return;
                if (type === 'labour' && !f.toLowerCase().includes('_jobcard.csv')) return;
                const cleanName = f.replace('_jobcard.csv','').replace('_schemes.csv','').replace('.csv','');
                fileSel.innerHTML += `<option value="${f}">${cleanName}</option>`;
            });
        }
        
        fileSel.onchange = function() { 
            loadBtn.disabled = !this.value; 
            if(type === 'scheme' && this.value) {
                const parts = this.value.split('_');
                if(parts.length > 0) document.getElementById('panchayat').value = parts[0];
            }
        };
        loadBtn.onclick = () => fetchServerFile(type, dist, block, fileSel.value);
    }

    function resetFileDropdowns() {
        ['scheme', 'labour'].forEach(type => {
            const el = document.getElementById(`${type}-sel-file`);
            el.innerHTML = `<option value="">-- Select File --</option>`;
            el.disabled = true;
            document.getElementById(`btn-load-${type}-server`).disabled = true;
        });
    }

    async function fetchServerFile(prefix, dist, block, fname) {
        const btn = document.getElementById(`btn-load-${prefix}-server`);
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/public/get-file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ district: dist, block: block, filename: fname })
            });
            const data = await res.json();
            
            if(data.content) {
                if(prefix === 'scheme') processSchemeCSV(data.content, `Server: ${fname}`);
                else processLabourCSV(data.content, `Server: ${fname}`);
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Loaded!';
            } else { alert('File empty'); btn.innerHTML = originalText; }
        } catch(e) { alert('Error loading file'); btn.innerHTML = originalText; } 
        finally { setTimeout(() => { if(btn.innerHTML.includes('Loaded')) btn.innerHTML = originalText; btn.disabled = false; }, 2000); }
    }

    // --- MODE TOGGLES ---
    function setupModeToggles() {
        document.getElementById('mode-batch').addEventListener('click', function() {
            currentMode = 'batch';
            document.getElementById('panel-batch').classList.remove('hidden'); 
            document.getElementById('panel-individual').classList.add('hidden');
            this.className = "text-sm font-bold text-primary border-b-2 border-primary pb-1";
            document.getElementById('mode-individual').className = "text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 pb-1";
        });

        document.getElementById('mode-individual').addEventListener('click', function() {
            currentMode = 'individual';
            document.getElementById('panel-individual').classList.remove('hidden'); 
            document.getElementById('panel-batch').classList.add('hidden');
            this.className = "text-sm font-bold text-primary border-b-2 border-primary pb-1";
            document.getElementById('mode-batch').className = "text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 pb-1";
        });
    }

    // --- DATA PROCESSING ---
    function processSchemeCSV(text, filename) {
        const rows = text.split(/\r?\n/);
        schemes = [];
        rows.forEach((row, index) => {
            if (index === 0 || !row.trim()) return;
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
            if (cols.length >= 2) schemes.push({ name: cols[0], code: cols[1] });
        });
        document.getElementById('scheme-control-area').classList.remove('hidden');
        populateSchemeDropdown(schemes);
    }

    function processLabourCSV(text, filename) {
        const rows = text.split(/\r?\n/);
        allLabours = [];
        rows.forEach((row, index) => {
            if (index === 0 || !row.trim()) return;
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
            if (cols.length >= 2 && !cols[0].includes('*')) {
                allLabours.push({ 
                    name: cols[0], 
                    card: cols[1],
                    searchStr: (cols[0] + " " + cols[1]).toLowerCase()
                });
            }
        });
        currentLabourIndex = 0;
        document.getElementById('labour-stats').classList.remove('hidden');
        updateStats();
        setupSmartSearch();
    }

    // --- SEARCH & INPUT LOGIC (UPDATED WITH VILLAGE SEARCH) ---
    function setupSmartSearch() {
        const input = document.getElementById('labour-search-input');
        const dropdown = document.getElementById('search-dropdown');
        
        input.addEventListener('input', function() {
            const term = this.value.trim().toLowerCase();
            if (term.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            // --- IMPROVEMENT 1: VILLAGE CODE DETECTION (e.g. "12/") ---
            const isVillageSearch = term.endsWith('/');
            const maxResults = isVillageSearch ? 500 : 15; // Show way more for village scan

            const results = allLabours
                .map((l, index) => {
                    let score = 0;
                    const cardLower = l.card.toLowerCase();
                    const nameLower = l.name.toLowerCase();

                    // If searching "12/", checking if card contains it
                    if (isVillageSearch) {
                        if (cardLower.includes(term)) score += 100;
                    } else {
                        if (cardLower.endsWith(term)) score += 100;
                        else if (cardLower.includes(term)) score += 50;
                        else if (nameLower.startsWith(term)) score += 30;
                        else if (nameLower.includes(term)) score += 10;
                    }

                    return { labour: l, index: index, score: score };
                })
                .filter(item => item.score > 0)
                // For village search, keep original list order (Index). For normal search, use Score.
                .sort((a, b) => isVillageSearch ? a.index - b.index : b.score - a.score)
                .slice(0, maxResults);

            renderDropdown(results);
        });

        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    function renderDropdown(results) {
        const dropdown = document.getElementById('search-dropdown');
        dropdown.innerHTML = '';
        
        if (results.length === 0) {
            dropdown.classList.add('hidden');
            return;
        }

        results.forEach(item => {
            const l = item.labour;
            const div = document.createElement('div');
            div.className = "p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-none";
            div.innerHTML = `
                <div class="font-bold text-sm text-gray-800 dark:text-gray-200">${l.name}</div>
                <div class="text-xs text-gray-500 font-mono">${l.card}</div>
            `;
            div.onclick = () => {
                selectLabourFromSearch(item.index);
                dropdown.classList.add('hidden');
                
                // Keep Village Code Logic
                const inputEl = document.getElementById('labour-search-input');
                const currentVal = inputEl.value;
                const slashIndex = currentVal.lastIndexOf('/');
                
                if (slashIndex !== -1) {
                    inputEl.value = currentVal.substring(0, slashIndex + 1);
                } else {
                    inputEl.value = '';
                }
                inputEl.focus(); 
            };
            dropdown.appendChild(div);
        });
        
        dropdown.classList.remove('hidden');
    }

    function selectLabourFromSearch(index) {
        addSingleLabour(index);
        lastSearchedIndex = index;
        refreshSuggestions(index);
    }

    // --- IMPROVEMENT 2: SUGGESTION AUTO-SCROLL/UPDATE ---
    function refreshSuggestions(baseIndex) {
        const box = document.getElementById('suggestions-box');
        const list = document.getElementById('suggestions-list');
        list.innerHTML = '';
        
        const tbody = document.getElementById('labour-tbody');
        const addedMap = new Set();
        tbody.querySelectorAll('tr').forEach(tr => {
            const name = tr.querySelector('input[name^="labour_name_"]').value;
            const card = tr.querySelector('input[name^="job_card_"]').value;
            addedMap.add(`${name}|${card}`);
        });

        let count = 0;
        // Start showing from next index immediately
        let i = baseIndex + 1;
        
        while(i < allLabours.length && count < 50) {
            const l = allLabours[i];
            const key = `${l.name}|${l.card}`;
            
            if(!addedMap.has(key)) {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white dark:bg-gray-800 p-2 rounded shadow-sm text-sm animate-fade-in";
                
                // Slight highlight for the VERY NEXT one
                if (count === 0) div.classList.add('border-l-4', 'border-green-500');

                div.innerHTML = `
                    <span class="truncate mr-2 font-medium">${l.name} <span class="text-xs text-gray-500 font-normal">(${l.card})</span></span>
                    <button type="button" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 shrink-0"
                        onclick="addSingleLabour(${i})">Add</button>
                `;
                list.appendChild(div);
                count++;
            }
            i++;
        }

        if(count > 0) box.classList.remove('hidden');
        else box.classList.add('hidden');
        
        // Ensure scroll is at top
        list.scrollTop = 0;
    }

    // --- ADD LABOUR LOGIC ---
    
    window.addSingleLabour = function(index) {
        if(index >= allLabours.length) return;
        const success = addToTable(allLabours[index]);
        if(success) {
            // Update suggestions to show NEXT neighbours immediately
            // This creates the "Auto Scroll" effect by putting next item at top
            lastSearchedIndex = index;
            refreshSuggestions(index);
        }
    };

    const btnIndivAdd = document.getElementById('btn-add-individual');
    if(btnIndivAdd) {
        btnIndivAdd.addEventListener('click', function() {
            const inputVal = document.getElementById('labour-search-input').value;
            if(!inputVal) return;
            const foundIndex = allLabours.findIndex(l => `${l.name} | ${l.card}` === inputVal);
            
            if(foundIndex !== -1) {
                addSingleLabour(foundIndex);
                
                const slashIndex = inputVal.lastIndexOf('/');
                if (slashIndex !== -1) {
                    document.getElementById('labour-search-input').value = inputVal.substring(0, slashIndex + 1);
                } else {
                    document.getElementById('labour-search-input').value = '';
                }
                
                lastSearchedIndex = foundIndex; 
                refreshSuggestions(foundIndex);
            } else {
                alert("Labour not found. Please select from dropdown.");
            }
        });
    }

    function addToTable(labour) {
        const tbody = document.getElementById('labour-tbody');
        
        let isDuplicate = false;
        tbody.querySelectorAll('tr').forEach(tr => {
            const existingName = tr.querySelector('input[name^="labour_name_"]').value;
            const existingCard = tr.querySelector('input[name^="job_card_"]').value;
            if (existingCard === labour.card && existingName === labour.name) {
                isDuplicate = true;
            }
        });

        if (isDuplicate) {
            alert(`Duplicate: ${labour.name} (${labour.card}) is already added.`);
            return false;
        }

        const rowIdx = new Date().getTime() + Math.random();
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors animate-fade-in";
        tr.innerHTML = `
            <td class="px-4 py-3 text-gray-500 font-mono text-xs"># <input type="hidden" name="labour_index" value="${rowIdx}"></td>
            <td class="px-4 py-3"><input type="text" name="job_card_${rowIdx}" value="${labour.card}" readonly class="w-full bg-transparent border-none p-0 text-gray-900 dark:text-gray-100 focus:ring-0"></td>
            <td class="px-4 py-3"><input type="text" name="labour_name_${rowIdx}" value="${labour.name}" readonly class="w-full bg-transparent border-none p-0 text-gray-900 dark:text-gray-100 focus:ring-0"></td>
            <td class="px-4 py-3 text-center"><button type="button" class="text-red-500 hover:text-red-700" onclick="removeRow(this)"><i class="fa-solid fa-xmark"></i></button></td>
        `;
        tbody.appendChild(tr);
        
        playSuccessSound();

        updatePreviewTitle();
        return true;
    }

    window.removeRow = function(btn) {
        btn.closest('tr').remove();
        updatePreviewTitle();
        if(lastSearchedIndex !== -1) refreshSuggestions(lastSearchedIndex);
    }

    document.getElementById('btn-add-batch').addEventListener('click', function() {
        if (allLabours.length === 0) { alert("Load list first."); return; }
        const countToAdd = parseInt(document.getElementById('labour_count').value) || 10;
        let addedCount = 0;
        let attemptIndex = currentLabourIndex;
        
        while(addedCount < countToAdd && attemptIndex < allLabours.length) {
            const success = addToTable(allLabours[attemptIndex]);
            if(success) addedCount++;
            attemptIndex++;
        }
        currentLabourIndex = attemptIndex;
        updateStats();
        if(lastSearchedIndex !== -1) refreshSuggestions(lastSearchedIndex);
    });

    async function autoSaveDemand() {
        const panchayat = document.getElementById('panchayat').value;
        const work_code = document.getElementById('hidden_work_code').value;
        const rows = document.querySelectorAll('#labour-tbody tr');
        
        if(!work_code || rows.length === 0) return; 

        const labourers = [];
        rows.forEach(row => {
            const nameInput = row.querySelector('input[name^="labour_name_"]');
            const cardInput = row.querySelector('input[name^="job_card_"]');
            if(nameInput && cardInput) {
                labourers.push({ name: nameInput.value, card: cardInput.value });
            }
        });

        fetch('/api/save-demand', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                panchayat: panchayat,
                work_code: work_code,
                labourers: labourers
            })
        }).then(res => res.json())
          .then(data => console.log("Auto-save:", data.message))
          .catch(err => console.error("Auto-save failed", err));
    }

    document.getElementById('btn-reset-all').addEventListener('click', () => {
        if(confirm("Are you sure you want to RESET EVERYTHING?")) {
             document.getElementById('labour-tbody').innerHTML = '';
             currentLabourIndex = 0;
             updateStats();
             updatePreviewTitle();
             if(lastSearchedIndex !== -1) refreshSuggestions(lastSearchedIndex);

             document.getElementById('hidden_scheme_name').value = '';
             document.getElementById('hidden_work_code').value = '';
             document.getElementById('panchayat').value = '';
             document.getElementById('scheme_select').value = '';
             document.getElementById('preview_scheme_name').textContent = 'None';
             document.getElementById('preview_work_code').textContent = 'None';
             document.getElementById('scheme-preview-text').classList.add('hidden');
        }
    });

    function updatePreviewTitle() {
        const count = document.getElementById('labour-tbody').querySelectorAll('tr').length;
        document.getElementById('form-preview-title').textContent = `Form Preview (${count} Labours)`;
    }

    window.adjustCount = function(c) {
        const i = document.getElementById('labour_count');
        let v = parseInt(i.value)||0; v+=c;
        if(v<1)v=1; if(v>20)v=20; i.value=v;
    }
    
    function updateStats() {
        document.getElementById('lbl-total').textContent = allLabours.length;
        document.getElementById('lbl-used').textContent = currentLabourIndex;
        document.getElementById('lbl-remain').textContent = allLabours.length - currentLabourIndex;
    }

    document.getElementById('scheme_csv').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const parts = file.name.split('_');
        if(parts.length > 0) document.getElementById('panchayat').value = parts[0];
        const r = new FileReader();
        r.onload = (ev) => processSchemeCSV(ev.target.result);
        r.readAsText(file);
    });
    
    document.getElementById('labour_csv').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = (ev) => processLabourCSV(ev.target.result);
        r.readAsText(file);
    });
    
    document.getElementById('scheme_filter').addEventListener('input', function(e) {
        const val = e.target.value.toLowerCase();
        const filtered = schemes.filter(s => s.code.toLowerCase().includes(val) || s.name.toLowerCase().includes(val));
        populateSchemeDropdown(filtered);
    });
    
    function populateSchemeDropdown(list) {
        const select = document.getElementById('scheme_select');
        select.innerHTML = '<option value="">-- Select Scheme --</option>';
        list.forEach(s => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify(s);
            opt.textContent = `${s.name.substring(0, 80)}... [${s.code}]`;
            select.appendChild(opt);
        });
    }
    
    document.getElementById('scheme_select').addEventListener('change', function() {
        if (!this.value) { document.getElementById('scheme-preview-text').classList.add('hidden'); return; }
        const data = JSON.parse(this.value);
        document.getElementById('hidden_scheme_name').value = data.name;
        document.getElementById('hidden_work_code').value = data.code;
        document.getElementById('preview_scheme_name').textContent = data.name;
        document.getElementById('preview_work_code').textContent = data.code;
        document.getElementById('scheme-preview-text').classList.remove('hidden');
    });
</script>
{% endblock %}