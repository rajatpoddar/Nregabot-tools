{% extends "base.html" %}

{% block title %}Allocation List{% endblock %}

{% block header_title %}Allocation List{% endblock %}

{% block content %}
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fa-solid fa-circle-info text-yellow-600 dark:text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    <strong>Note:</strong> Yahan par report ka text paste karein jismein se Work Codes (e.g., 3422003014/RC/...) extract karne hain.
                </p>
            </div>
        </div>
    </div>
    
    <form action="{{ url_for('allocation_list') }}" method="post" class="space-y-6">
        
        <div>
            <label for="panchayat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Panchayat Name</label>
            <input type="text" id="panchayat" name="panchayat" placeholder="e.g., Palojori (file naam ke liye)" required
                class="w-full md:w-1/2 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm">
        </div>

        <div>
            <label for="text_data" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Paste Text Block Here</label>
            <textarea id="text_data" name="text_data" rows="15" placeholder="Yahan poora text paste karein..." required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-mono text-sm placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm"></textarea>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 pt-2">
            <button type="submit" class="inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all transform hover:-translate-y-0.5">
                <i class="fa-solid fa-file-csv mr-2"></i> Extract & Download CSV
            </button>
            
            <button id="save-cloud-btn" type="button" class="inline-flex justify-center items-center px-6 py-3 border border-gray-300 dark:border-gray-600 shadow-sm text-base font-medium rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Save to Cloud
            </button>
        </div>
    </form>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('save-cloud-btn').addEventListener('click', async function() {
        const contentProvider = function() {
            const text_data = document.getElementById('text_data').value;
            if (!text_data) { alert('Please paste some text to extract.'); return null; }
    
            // Regex to extract codes
            const pattern = /\b(34\d{8}(?:\/\w+)+\/\d+)\b/g;
            const matches = [...text_data.matchAll(pattern)];
            
            if (!matches || matches.length === 0) { alert('No work codes found in the provided text.'); return null; }
    
            const uniqueCodes = [...new Set(matches.map(m => m[1]))];
            return "Work Code\n" + uniqueCodes.join("\n");
        };
        
        const panchayat = document.getElementById('panchayat').value.trim();
        if (!panchayat) { alert('Please enter a Panchayat Name to save the file.'); return; }
        
        const baseFilename = panchayat + '_workcodes.csv';
    
        // Global helper function from base.html
        await handleCloudSaveClick(contentProvider, 'Uploads/worklist', baseFilename, this);
    });
</script>
{% endblock %}