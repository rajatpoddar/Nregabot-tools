{% extends "base.html" %}
{% block title %}Scheme List{% endblock %}

{% block header_title %}Scheme List (WC Gen){% endblock %}

{% block content %}
    <style>
        .grid-input {
            width: 100%;
            background-color: transparent;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        .grid-input:focus {
            background-color: #eff6ff; /* blue-50 */
            outline: 2px solid #3b82f6; /* blue-500 */
        }
        .dark .grid-input:focus {
            background-color: #1e3a8a;
            outline: 2px solid #60a5fa;
            color: #fff;
        }
        
        .col-priority { min-width: 80px; }
        .col-work-name { min-width: 350px; }
        .col-normal { min-width: 120px; }
        .col-job-card { min-width: 200px; }
    </style>

    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg shadow-sm">
        <div class="flex flex-col gap-2">
            <div class="flex">
                <div class="flex-shrink-0"><i class="fa-solid fa-lightbulb text-yellow-600 dark:text-yellow-400"></i></div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 dark:text-yellow-300">
                        <strong>Smart Paste Feature (New!):</strong> Aap Excel ya Numbers se data copy karke seedha kisi bhi cell par paste (Ctrl+V) kar sakte hain. Data apne aap fill ho jayega!
                    </p>
                </div>
            </div>
            <div class="flex ml-8 text-xs text-yellow-600 dark:text-yellow-500">
                <i class="fa-solid fa-arrow-turn-up fa-rotate-90 mr-2 mt-1"></i>
                <span>Auto-fill: First row bharne ke baad, agle row mein click karein to upar wala data copy ho jayega (except Priority).</span>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-4">
        <div class="w-full md:w-1/3">
            <label for="panchayat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Panchayat Name</label>
            <input type="text" id="panchayat" name="panchayat" placeholder="e.g., Palojori (file naam ke liye)" required
                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all shadow-sm">
        </div>

        <div class="hidden md:flex gap-2">
            <button id="scroll-left-btn" class="p-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-300 transition-colors disabled:opacity-50 shadow-sm" title="Scroll Left">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <button id="scroll-right-btn" class="p-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-300 transition-colors disabled:opacity-50 shadow-sm" title="Scroll Right">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div id="scroll-container" class="border border-gray-200 dark:border-gray-700 rounded-xl overflow-auto max-h-[65vh] shadow-sm bg-white dark:bg-dark-card relative">
        <table id="work-code-table" class="min-w-max text-sm text-left">
            <thead class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 uppercase font-bold text-xs sticky top-0 z-10 shadow-sm">
                <tr>
                    <th class="px-3 py-3 col-priority border-b border-gray-200 dark:border-gray-700">priority</th>
                    <th class="px-3 py-3 col-work-name border-b border-gray-200 dark:border-gray-700">work_name</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">khata_no</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">plot_no</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">village_name</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">total_plants</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">covered_area</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">area_plantation</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">total_saplings</th>
                    <th class="px-3 py-3 col-job-card border-b border-gray-200 dark:border-gray-700">job_card</th>
                    <th class="px-3 py-3 col-normal border-b border-gray-200 dark:border-gray-700">beneficiary_type</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-800 text-gray-700 dark:text-gray-200">
                {% for i in range(10) %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 group">
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                    <td class="p-1"><input type="text" class="grid-input" value=""></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div> 

    <div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
        <button id="add-row-btn" class="flex-1 md:flex-none inline-flex justify-center items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg shadow-sm transition-colors text-sm font-medium">
            <i class="fa-solid fa-plus mr-2"></i> Add Row
        </button>
        <button id="download-csv" class="flex-1 md:flex-none inline-flex justify-center items-center px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg shadow-sm transition-colors text-sm font-medium">
            <i class="fa-solid fa-download mr-2"></i> Download CSV
        </button>
        <button id="save-cloud-btn" type="button" class="flex-1 md:flex-none inline-flex justify-center items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium">
            <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Save to Cloud
        </button>
    </div>

<script>
    const tableBody = document.getElementById('work-code-table').querySelector('tbody');

    // --- SMART PASTE LOGIC (EXCEL / NUMBERS) ---
    document.addEventListener('paste', function(e) {
        // Sirf tab active ho jab user kisi input field par ho
        if (!e.target.classList.contains('grid-input')) return;
        
        e.preventDefault();
        
        // Clipboard Data lo
        const text = e.clipboardData.getData('text');
        // Rows split karo (Excel uses newline)
        const rows = text.split(/\r?\n/).filter(r => r.length > 0);
        
        // Current position pata karo
        const currentInput = e.target;
        const currentRow = currentInput.closest('tr');
        const currentCell = currentInput.closest('td');
        
        // Table mein current index kya hai
        const startRowIndex = Array.from(tableBody.children).indexOf(currentRow);
        const startCellIndex = Array.from(currentRow.children).indexOf(currentCell);

        // Data loop karo
        rows.forEach((rowText, rIndex) => {
            const cells = rowText.split('\t'); // Excel uses tabs for columns
            
            // Agar rows khatam ho gayi hain, to nayi add karo
            if (startRowIndex + rIndex >= tableBody.children.length) {
                // Add Row button ko click karke nayi row banwao (taaki saare styles sahi rahe)
                document.getElementById('add-row-btn').click();
            }
            
            const targetRow = tableBody.children[startRowIndex + rIndex];
            
            if (targetRow) {
                cells.forEach((cellText, cIndex) => {
                    // Cell dhoondo
                    const targetCell = targetRow.children[startCellIndex + cIndex];
                    if (targetCell) {
                        const input = targetCell.querySelector('input');
                        if (input) {
                            input.value = cellText.trim();
                            // Chhota animation visual feedback ke liye
                            input.style.backgroundColor = '#dbeafe'; // light blue highlight
                            setTimeout(() => { input.style.backgroundColor = ''; }, 300);
                        }
                    }
                });
            }
        });
    });

    // --- CSV Download Logic ---
    document.getElementById('download-csv').addEventListener('click', function() {
        let csvContent = "data:text/csv;charset=utf-8,";
        const table = document.getElementById('work-code-table');
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        csvContent += headers.join(',') + '\r\n';
        const rows = table.querySelectorAll('tbody tr');
        let hasData = false;
        rows.forEach(row => {
            const rowInputs = row.querySelectorAll('input');
            const rowData = Array.from(rowInputs).map(input => `"${input.value.replace(/"/g, '""')}"`);
            if (Array.from(rowInputs).some(input => input.value.trim() !== '')) {
                csvContent += rowData.join(',') + '\r\n';
                hasData = true;
            }
        });
        if (!hasData) { alert("Please enter some data before downloading."); return; }
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', 'work_code_data.csv');
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    });

    // --- Add Row Logic ---
    document.getElementById('add-row-btn').addEventListener('click', function() {
        const newRow = document.createElement('tr');
        newRow.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 group";
        newRow.innerHTML = `
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
            <td class="p-1"><input type="text" class="grid-input" value=""></td>
        `;
        tableBody.appendChild(newRow);
        setTimeout(updateButtonStates, 100);
    });

    // --- Auto-Fill (Copy from above) ---
    tableBody.addEventListener('focusin', function(e) {
        if (e.target && e.target.tagName === 'INPUT') {
            const currentInput = e.target;
            if (currentInput.value.trim() !== '') return;
            const currentRow = currentInput.closest('tr');
            const previousRow = currentRow.previousElementSibling;
            if (previousRow) {
                const currentCell = currentInput.closest('td');
                const cellIndex = Array.from(currentRow.children).indexOf(currentCell);
                const inputAbove = previousRow.children[cellIndex]?.querySelector('input');
                if (inputAbove) {
                    if (cellIndex === 0) { // Priority logic
                        const numberAbove = parseInt(inputAbove.value, 10);
                        currentInput.value = !isNaN(numberAbove) ? numberAbove + 1 : inputAbove.value;
                    } else {
                        currentInput.value = inputAbove.value;
                    }
                }
            }
        }
    });

    // --- Scroll Buttons ---
    const scrollContainer = document.getElementById('scroll-container');
    const scrollLeftBtn = document.getElementById('scroll-left-btn');
    const scrollRightBtn = document.getElementById('scroll-right-btn');
    
    function updateButtonStates() {
        if (!scrollContainer || !scrollLeftBtn || !scrollRightBtn) return;
        const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth;
        scrollLeftBtn.disabled = scrollContainer.scrollLeft <= 0;
        scrollRightBtn.disabled = scrollContainer.scrollLeft >= maxScrollLeft - 1;
    }

    if (scrollContainer && scrollLeftBtn && scrollRightBtn) {
        const scrollAmount = 300; 
        scrollLeftBtn.addEventListener('click', function() { scrollContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' }); });
        scrollRightBtn.addEventListener('click', function() { scrollContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' }); });
        scrollContainer.addEventListener('scroll', updateButtonStates);
        window.addEventListener('resize', updateButtonStates);
        setTimeout(updateButtonStates, 300); 
    }
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Cloud Save
    document.getElementById('save-cloud-btn').addEventListener('click', async function() {
        const contentProvider = function() {
            let csvContent = "";
            const table = document.getElementById('work-code-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            csvContent += headers.join(',') + '\r\n';
            const rows = table.querySelectorAll('tbody tr');
            let hasData = false;
            rows.forEach(row => {
                const rowInputs = row.querySelectorAll('input');
                const rowData = Array.from(rowInputs).map(input => `"${input.value.replace(/"/g, '""')}"`);
                if (Array.from(rowInputs).some(input => input.value.trim() !== '')) {
                    csvContent += rowData.join(',') + '\r\n';
                    hasData = true;
                }
            });
            if (!hasData) { alert("Please enter some data before saving."); return null; }
            return csvContent;
        };
        
        const panchayat = document.getElementById('panchayat').value.trim();
        if (!panchayat) { alert('Please enter a Panchayat Name to save the file.'); return; }
        const baseFilename = panchayat + '_scheme_list_data.csv';
    
        await handleCloudSaveClick(contentProvider, 'Uploads/workcode_generator', baseFilename, this);
    });
</script>
{% endblock %}